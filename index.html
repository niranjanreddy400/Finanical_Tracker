<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Financial Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom: 3px solid #6366F1;
            color: #6366F1;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <!-- Login Page -->
    <div id="login-container" class="bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-sm hidden">
        <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">Login</h2>
        <p class="text-center text-gray-400 mb-6">Sign in to access your dashboard</p>
        <div class="space-y-4">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                Sign in Anonymously
            </button>
        </div>
        <p class="text-center text-gray-500 text-sm mt-4">No password needed. Your data is tied to this device.</p>
    </div>

    <!-- Main Dashboard -->
    <div id="app-container" class="bg-gray-800 rounded-2xl shadow-lg w-full max-w-7xl h-auto overflow-hidden flex flex-col hidden">

        <!-- Header -->
        <div class="p-6 bg-gray-900 flex justify-between items-center rounded-t-2xl">
            <h1 class="text-2xl font-bold text-indigo-500">My Financial Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="user-id-display" class="bg-gray-700 text-gray-300 text-xs px-3 py-1 rounded-full truncate max-w-xs">User ID: N/A</span>
                <button id="logout-btn" class="text-gray-400 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex-grow flex flex-col p-6 space-y-4">
            <div class="flex space-x-2 border-b-2 border-gray-700">
                <button id="dashboard-tab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 rounded-t-lg active">Dashboard</button>
                <button id="stocks-tab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 rounded-t-lg">Stocks</button>
                <button id="credits-tab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 rounded-t-lg">Credits</button>
                <button id="debts-tab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 rounded-t-lg">Debts</button>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Net Worth Card -->
                <div class="bg-gray-900 p-6 rounded-xl shadow-inner col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-gray-400 text-lg font-medium">Net Worth</h3>
                    <p id="net-worth" class="text-4xl font-bold mt-2 text-green-500">₹0</p>
                    <p class="text-sm text-gray-500">Total assets minus total liabilities</p>
                </div>
                <!-- Total Stocks Card -->
                <div class="bg-gray-900 p-6 rounded-xl shadow-inner">
                    <h3 class="text-gray-400 text-lg font-medium">Total Stocks</h3>
                    <p id="total-stocks" class="text-3xl font-bold mt-2 text-indigo-400">₹0</p>
                </div>
                <!-- Total Credits Card -->
                <div class="bg-gray-900 p-6 rounded-xl shadow-inner">
                    <h3 class="text-gray-400 text-lg font-medium">Total Credits</h3>
                    <p id="total-credits" class="text-3xl font-bold mt-2 text-cyan-400">₹0</p>
                </div>
                <!-- Total Debts Card -->
                <div class="bg-gray-900 p-6 rounded-xl shadow-inner">
                    <h3 class="text-gray-400 text-lg font-medium">Total Debts</h3>
                    <p id="total-debts" class="text-3xl font-bold mt-2 text-rose-400">₹0</p>
                </div>

                <!-- Financial Health Charts -->
                <div class="md:col-span-2 lg:col-span-2 bg-gray-900 p-6 rounded-xl shadow-inner flex flex-col items-center">
                    <h3 class="text-gray-400 text-lg font-medium mb-4">Financial Composition</h3>
                    <div id="bar-chart-container" class="w-full flex justify-center items-end h-64 relative">
                        <!-- Bar chart rendered here by JS -->
                    </div>
                </div>

                <!-- AI Agent Button -->
                <div class="md:col-span-2 lg:col-span-1 bg-gray-900 p-6 rounded-xl shadow-inner flex flex-col justify-between">
                    <div>
                        <h3 class="text-gray-400 text-lg font-medium">AI Financial Agent</h3>
                        <p class="text-sm text-gray-500 mt-1">Get personalized alerts and insights based on your finances.</p>
                    </div>
                    <button id="ai-agent-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-200 mt-4">
                        Get Financial Insights
                    </button>
                    <div id="ai-alerts-container" class="mt-4 p-3 bg-gray-700 rounded-lg max-h-40 overflow-y-auto hidden">
                        <p id="ai-alerts-text" class="text-sm text-gray-300 italic"></p>
                    </div>
                </div>
            </div>

            <!-- Stocks View -->
            <div id="stocks-view" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Stocks</h2>
                    <button id="fetch-zerodha-btn" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                        <div class="flex items-center space-x-2">
                            <span>Fetch from Zerodha</span>
                        </div>
                    </button>
                </div>
                <div class="overflow-x-auto bg-gray-900 rounded-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Symbol</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Buy Price</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Current Price</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">P&L</th>
                            </tr>
                        </thead>
                        <tbody id="stocks-table" class="bg-gray-800 divide-y divide-gray-700">
                            <!-- Stock items will be added here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Credits View -->
            <div id="credits-view" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4">Credits</h2>
                <form id="add-credit-form" class="bg-gray-900 p-6 rounded-xl shadow-inner grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="credit-person" placeholder="Person Name" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="credit-amount" placeholder="Amount (₹)" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="credit-rate" placeholder="Interest Rate (%)" step="0.01" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="credit-tenure" placeholder="Tenure (months)" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200">Add Credit</button>
                </form>
                <div class="overflow-x-auto bg-gray-900 rounded-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Person</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Principal</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tenure</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rate (%)</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Interest</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="credits-table" class="bg-gray-800 divide-y divide-gray-700">
                            <!-- Credit items will be added here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Debts View -->
            <div id="debts-view" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4">Debts</h2>
                <form id="add-debt-form" class="bg-gray-900 p-6 rounded-xl shadow-inner grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="debt-person" placeholder="Person Name" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="debt-amount" placeholder="Amount (₹)" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="debt-rate" placeholder="Interest Rate (%)" step="0.01" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="debt-tenure" placeholder="Tenure (months)" required class="bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200">Add Debt</button>
                </form>
                <div class="overflow-x-auto bg-gray-900 rounded-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Person</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Principal</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tenure</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rate (%)</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Interest</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="debts-table" class="bg-gray-800 divide-y divide-gray-700">
                            <!-- Debt items will be added here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Confirmations -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4">Confirm Action</h3>
            <p id="modal-message" class="text-gray-400 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE
        // It's crucial for the app to connect to your database.
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyB-oqOuVoNJWmpW1KAq8eqEXiQtvYfxSdk",
          authDomain: "financialtracker-mani.firebaseapp.com",
          projectId: "financialtracker-mani",
          storageBucket: "financialtracker-mani.firebasestorage.app",
          messagingSenderId: "291386637366",
          appId: "1:291386637366:web:090b26f9652a394cbdec97",
          measurementId: "G-HF9JZC689P"
        };
        // Replace the above object with your actual Firebase config.

        // Initialize Firebase services
        let app, auth, db, userId;

        const appId = 'default-app-id';

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase config is not available. Please ensure the app is configured correctly.", e);
        }

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addCreditForm = document.getElementById('add-credit-form');
        const addDebtForm = document.getElementById('add-debt-form');
        const creditsTable = document.getElementById('credits-table');
        const debtsTable = document.getElementById('debts-table');
        const stocksTable = document.getElementById('stocks-table');
        const dashboardTab = document.getElementById('dashboard-tab');
        const stocksTab = document.getElementById('stocks-tab');
        const creditsTab = document.getElementById('credits-tab');
        const debtsTab = document.getElementById('debts-tab');
        const dashboardView = document.getElementById('dashboard-view');
        const stocksView = document.getElementById('stocks-view');
        const creditsView = document.getElementById('credits-view');
        const debtsView = document.getElementById('debts-view');
        const netWorthDisplay = document.getElementById('net-worth');
        const totalStocksDisplay = document.getElementById('total-stocks');
        const totalCreditsDisplay = document.getElementById('total-credits');
        const totalDebtsDisplay = document.getElementById('total-debts');
        const barChartContainer = document.getElementById('bar-chart-container');
        const fetchZerodhaBtn = document.getElementById('fetch-zerodha-btn');
        const aiAgentBtn = document.getElementById('ai-agent-btn');
        const aiAlertsContainer = document.getElementById('ai-alerts-container');
        const aiAlertsText = document.getElementById('ai-alerts-text');
        const confirmModal = document.getElementById('confirm-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let totalStocks = 0;
        let totalCredits = 0;
        let totalDebts = 0;
        let creditsData = [];
        let debtsData = [];
        let stocksData = [];

        // Firebase Authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Initialize listeners for all data
                setupRealtimeListeners();
            } else {
                userId = null;
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Sign-in failed:", error);
                alert("Sign-in failed. Please try again.");
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-out failed:", error);
            }
        });
        
        // Modal logic
        let currentModalAction;
        const showModal = (message, onConfirm) => {
            modalMessage.textContent = message;
            currentModalAction = onConfirm;
            confirmModal.classList.remove('hidden');
        };

        modalConfirmBtn.addEventListener('click', () => {
            if (currentModalAction) {
                currentModalAction();
            }
            confirmModal.classList.add('hidden');
        });

        modalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            currentModalAction = null;
        });

        // Tab Switching
        const tabs = {
            'dashboard': { btn: dashboardTab, view: dashboardView },
            'stocks': { btn: stocksTab, view: stocksView },
            'credits': { btn: creditsTab, view: creditsView },
            'debts': { btn: debtsTab, view: debtsView }
        };

        const switchTab = (activeTab) => {
            for (const tab in tabs) {
                tabs[tab].btn.classList.remove('active');
                tabs[tab].view.classList.add('hidden');
            }
            tabs[activeTab].btn.classList.add('active');
            tabs[activeTab].view.classList.remove('hidden');
        };

        Object.keys(tabs).forEach(tabName => {
            tabs[tabName].btn.addEventListener('click', () => switchTab(tabName));
        });

        // Realtime Database Listeners
        function setupRealtimeListeners() {
            if (!db || !userId) {
                console.error("Database or User ID not available.");
                return;
            }

            const creditsColRef = collection(db, `/artifacts/${appId}/users/${userId}/credits`);
            onSnapshot(creditsColRef, (snapshot) => {
                creditsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCreditsTable(creditsData);
                updateDashboard();
            });

            const debtsColRef = collection(db, `/artifacts/${appId}/users/${userId}/debts`);
            onSnapshot(debtsColRef, (snapshot) => {
                debtsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDebtsTable(debtsData);
                updateDashboard();
            });

            const stocksColRef = collection(db, `/artifacts/${appId}/users/${userId}/stocks`);
            onSnapshot(stocksColRef, (snapshot) => {
                stocksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStocksTable(stocksData);
                updateDashboard();
            });
        }

        function calculateInterest(principal, rate, tenure, startDate) {
            const today = new Date();
            const dateGiven = startDate.seconds ? new Date(startDate.seconds * 1000) : new Date(startDate);
            const monthsPassed = Math.min(
                Math.ceil((today - dateGiven) / (1000 * 60 * 60 * 24 * 30)),
                tenure
            );
            
            // Simple interest calculation: P * R * T / 100
            const timeInYears = monthsPassed / 12;
            return principal * rate * timeInYears / 100;
        }

        // Dashboard Logic
        function updateDashboard() {
            totalStocks = 0;
            totalCredits = 0;
            totalDebts = 0;
            
            // Calculate from data arrays instead of DOM
            stocksData.forEach(stock => {
                const currentValue = stock.quantity * stock.current_price;
                totalStocks += currentValue;
            });
            
            creditsData.forEach(credit => {
                if (!credit.isPaid) {
                    const interest = calculateInterest(credit.amount, credit.rate, credit.tenure, credit.createdAt);
                    const total = credit.amount + interest;
                    totalCredits += total;
                }
            });
            
            debtsData.forEach(debt => {
                if (!debt.isPaid) {
                    const interest = calculateInterest(debt.amount, debt.rate, debt.tenure, debt.createdAt);
                    const total = debt.amount + interest;
                    totalDebts += total;
                }
            });

            const netWorth = totalStocks + totalCredits - totalDebts;
            netWorthDisplay.textContent = `₹${netWorth.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
            totalStocksDisplay.textContent = `₹${totalStocks.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
            totalCreditsDisplay.textContent = `₹${totalCredits.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
            totalDebtsDisplay.textContent = `₹${totalDebts.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
            updateBarChart();
        }

        function updateBarChart() {
            const chartData = [
                { label: 'Stocks', value: totalStocks, color: '#4F46E5' },
                { label: 'Credits', value: totalCredits, color: '#06B6D4' },
                { label: 'Debts', value: totalDebts, color: '#F43F5E' }
            ];

            const maxValue = Math.max(...chartData.map(item => item.value), 1);
            barChartContainer.innerHTML = ''; // Clear existing chart

            chartData.forEach(item => {
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex flex-col items-center mx-2';
                barChartContainer.appendChild(barWrapper);

                const barHeight = (item.value / maxValue) * 100;
                const bar = document.createElement('div');
                bar.className = `w-12 rounded-lg transition-all duration-500 ease-in-out`;
                bar.style.backgroundColor = item.color;
                bar.style.height = `${barHeight}px`;

                const label = document.createElement('div');
                label.className = 'mt-2 text-xs text-gray-400';
                label.textContent = item.label;

                const value = document.createElement('div');
                value.className = 'text-sm font-bold mt-1';
                value.textContent = `₹${Math.round(item.value).toLocaleString()}`;

                barWrapper.appendChild(bar);
                barWrapper.appendChild(value);
                barWrapper.appendChild(label);
            });
        }

        // Table updates
        function updateCreditsTable(credits) {
            creditsTable.innerHTML = '';
            credits.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            credits.forEach(item => {
                const interest = calculateInterest(item.amount, item.rate, item.tenure, item.createdAt);
                const total = item.amount + interest;
                const status = item.isPaid ? 'Paid' : 'Pending';
                const statusClass = item.isPaid ? 'text-green-400' : 'text-yellow-400';
                const row = `
                    <tr class="${item.isPaid ? 'opacity-60' : ''}">
                        <td class="px-4 py-2 whitespace-nowrap">${item.person}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${item.amount.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.tenure} months</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.rate}%</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${interest.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${total.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="px-4 py-2 whitespace-nowrap ${statusClass}">${status}</td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            ${!item.isPaid ? `<button data-id="${item.id}" class="mark-credit-paid-btn text-green-500 hover:text-green-700 mr-2">Mark Paid</button>` : ''}
                            <button data-id="${item.id}" class="delete-credit-btn text-red-500 hover:text-red-700">Delete</button>
                        </td>
                    </tr>
                `;
                creditsTable.innerHTML += row;
            });

            document.querySelectorAll('.mark-credit-paid-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    showModal('Are you sure you want to mark this credit as paid?', async () => {
                        await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/credits`, id), { 
                            isPaid: true,
                            paidAt: serverTimestamp()
                        });
                    });
                });
            });

            document.querySelectorAll('.delete-credit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    showModal('Are you sure you want to delete this credit?', async () => {
                        await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/credits`, id));
                    });
                });
            });
        }

        function updateDebtsTable(debts) {
            debtsTable.innerHTML = '';
            debts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            debts.forEach(item => {
                const interest = calculateInterest(item.amount, item.rate, item.tenure, item.createdAt);
                const total = item.amount + interest;
                const status = item.isPaid ? 'Paid' : 'Pending';
                const statusClass = item.isPaid ? 'text-green-400' : 'text-red-400';
                const row = `
                    <tr class="${item.isPaid ? 'opacity-60' : ''}">
                        <td class="px-4 py-2 whitespace-nowrap">${item.person}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${item.amount.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.tenure} months</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.rate}%</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${interest.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${total.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="px-4 py-2 whitespace-nowrap ${statusClass}">${status}</td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            ${!item.isPaid ? `<button data-id="${item.id}" data-person="${item.person}" data-amount="${item.amount}" class="mark-paid-btn text-green-500 hover:text-green-700 ml-2">Mark Paid</button>` : ''}
                            <button data-id="${item.id}" class="delete-debt-btn text-red-500 hover:text-red-700 ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                debtsTable.innerHTML += row;
            });

            document.querySelectorAll('.delete-debt-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    showModal('Are you sure you want to delete this debt?', async () => {
                        await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/debts`, id));
                    });
                });
            });

            document.querySelectorAll('.mark-paid-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const person = e.target.dataset.person;
                    const amount = parseFloat(e.target.dataset.amount);

                    showModal('Are you sure you want to mark this debt as paid? This will also update the corresponding credit.', async () => {
                        const batch = writeBatch(db);
                        const debtRef = doc(db, `/artifacts/${appId}/users/${userId}/debts`, id);
                        batch.update(debtRef, { 
                            isPaid: true,
                            paidAt: serverTimestamp()
                        });
                        
                        const creditsRef = collection(db, `/artifacts/${appId}/users/${userId}/credits`);
                        const q = query(creditsRef, where("person", "==", person), where("amount", "==", amount), where("isPaid", "==", false));
                        const creditsSnapshot = await getDocs(q);

                        if (!creditsSnapshot.empty) {
                            creditsSnapshot.forEach(doc => {
                                batch.update(doc.ref, { 
                                    isPaid: true,
                                    paidAt: serverTimestamp()
                                });
                            });
                        }
                        await batch.commit();
                    });
                });
            });
        }

        function updateStocksTable(stocks) {
            stocksTable.innerHTML = '';
            stocks.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
            stocks.forEach(item => {
                const currentValue = item.quantity * item.current_price;
                const cost = item.quantity * item.buy_price;
                const pnl = currentValue - cost;
                const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const row = `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap">${item.symbol}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${item.quantity}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${item.buy_price.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${item.current_price.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap">₹${currentValue.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap ${pnlClass}">₹${pnl.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
                stocksTable.innerHTML += row;
            });
        }

        // Form Submission Handlers
        addCreditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const person = document.getElementById('credit-person').value;
            const amount = parseFloat(document.getElementById('credit-amount').value);
            const rate = parseFloat(document.getElementById('credit-rate').value);
            const tenure = parseInt(document.getElementById('credit-tenure').value);
            
            if (person && amount > 0 && rate >= 0 && tenure > 0) {
                const creditsColRef = collection(db, `/artifacts/${appId}/users/${userId}/credits`);
                await addDoc(creditsColRef, {
                    person,
                    amount,
                    rate,
                    tenure,
                    isPaid: false,
                    createdAt: serverTimestamp()
                });
                addCreditForm.reset();
            } else {
                alert('Please fill all fields with valid values');
            }
        });

        addDebtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const person = document.getElementById('debt-person').value;
            const amount = parseFloat(document.getElementById('debt-amount').value);
            const rate = parseFloat(document.getElementById('debt-rate').value);
            const tenure = parseInt(document.getElementById('debt-tenure').value);

            if (person && amount > 0 && rate >= 0 && tenure > 0) {
                const debtsColRef = collection(db, `/artifacts/${appId}/users/${userId}/debts`);
                await addDoc(debtsColRef, {
                    person,
                    amount,
                    rate,
                    tenure,
                    isPaid: false,
                    createdAt: serverTimestamp()
                });
                addDebtForm.reset();
            } else {
                alert('Please fill all fields with valid values');
            }
        });
        
        // Zerodha API Fetcher
        fetchZerodhaBtn.addEventListener('click', async () => {
            loadingOverlay.classList.remove('hidden');
            try {
                // IMPORTANT: Replace this with your deployed Python backend URL.
                const backendUrl = 'YOUR_RENDER_BACKEND_URL_HERE';
                const response = await fetch(backendUrl);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const batch = writeBatch(db);
                    const stocksColRef = collection(db, `/artifacts/${appId}/users/${userId}/stocks`);
                    
                    const existingStocksSnapshot = await getDocs(query(stocksColRef, where("source", "==", "Zerodha")));
                    existingStocksSnapshot.forEach(doc => batch.delete(doc.ref));

                    result.data.forEach(stock => {
                        batch.set(doc(stocksColRef), {
                            ...stock,
                            createdAt: serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                } else {
                    console.error("API Error:", result.message);
                }
            } catch (e) {
                console.error("Error fetching Zerodha data:", e);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // AI Agent Functionality
        aiAgentBtn.addEventListener('click', async () => {
            aiAlertsContainer.classList.remove('hidden');
            aiAlertsText.textContent = 'Generating insights...';

            const payload = {
                contents: [
                    {
                        parts: [
                            {
                                text: `Act as a senior financial advisor with 30+ years of experience. I am an individual user trying to track my personal finances. My current financial summary is: Net Worth: ₹${totalStocks + totalCredits - totalDebts}. Total Stocks: ₹${totalStocks}. Total Credits: ₹${totalCredits}. Total Debts: ₹${totalDebts}. Based on this data, provide 2-3 concise, actionable financial alerts or insights. Be encouraging and informative.`
                            }
                        ]
                    }
                ],
                tools: [{"google_search": {}}],
            };
            
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    aiAlertsText.textContent = generatedText;
                } else {
                    aiAlertsText.textContent = "Error: Unable to generate insights.";
                }

            } catch (e) {
                console.error("Error with AI Agent:", e);
                aiAlertsText.textContent = "Error: Could not connect to AI agent.";
            }
        });

    </script>
</body>
</html>